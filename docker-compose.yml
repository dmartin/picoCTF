version: "3.7"
services:
  ui:
    image: picoctf/ui
    build:
      context: ui
    container_name: pico_ui
    ports:
      - target: 443
        published: 13371
        protocol: tcp
        mode: host
    depends_on:
      - api
      - webshell-dispatch
    networks:
      - api-components
  api:
    image: picoctf/api
    build:
      context: api
    container_name: pico_api
    depends_on:
      - mongo
      - redis
    networks:
      - api-components
      - db-backend
      - webshell-auth
  cache-daemon:
    image: picoctf/api
    build:
      context: api
    container_name: pico_cache_daemon
    depends_on:
      - mongo
      - redis
      - api
    entrypoint:
      - python
      - -u
      - /app/cache_daemon.py
    networks:
      - db-backend
  mongo:
    image: mongo:4.2-bionic
    container_name: pico_mongo
    networks:
      - db-backend
  redis:
    image: redis:5
    container_name: pico_redis
    networks:
      - db-backend
  webshell-dispatch:
    image: picoctf/webshell-dispatch
    build:
      context: webshell
      dockerfile: dispatcher.Dockerfile
    container_name: pico_webshell_dispatch
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - webshell-toolbox
  webshell-toolbox:
    # Not used, but included so that the toolbox image is built.
    # See https://github.com/docker/compose/issues/1896
    image: picoctf/toolbox
    build:
      context: webshell
      dockerfile: toolbox.Dockerfile
    depends_on:
      - api
networks:
  api-components:
  db-backend:
  webshell-auth:
volumes:
  webshell-homes:
    external: false
